# Export System Documentation

This document explains how the Research Engine's dynamic export system automatically includes all AI-generated content in PDF and JSON exports.

## Core Principle

**All exports are dynamically generated** from the `research_results` JSONB data. When the N8N system prompt generates new sections, they automatically appear in both PDF and JSON exports without any code changes.

## Export Architecture

### 1. Dynamic PDF Export
The PDF export system automatically includes all analysis sections:

```typescript
export const exportResearchToPDF = async (research: any, companyName: string) => {
  const doc = new jsPDF();
  const { research_results } = research;
  
  // Executive Summary (always first)
  if (research_results.executive_summary) {
    addExecutiveSummary(doc, research_results.executive_summary);
  }
  
  // All other sections dynamically
  Object.entries(research_results)
    .filter(([key]) => key !== 'executive_summary' && research_results[key])
    .forEach(([sectionKey, sectionData]) => {
      const sectionTitle = getSectionTitle(sectionKey);
      addDynamicSection(doc, sectionTitle, sectionData);
    });
    
  return doc;
};
```

### 2. Complete JSON Export  
The JSON export includes the complete research record:

```typescript
export const exportToJSON = (research: any) => {
  return {
    company_name: research.company_name,
    research_date: research.created_at,
    fit_score: research.fit_score,
    status: research.status,
    
    // Complete research_results object (all AI-generated content)
    analysis_results: research.research_results,
    
    // Metadata
    export_date: new Date().toISOString(),
    version: '1.0'
  };
};
```

## Dynamic Content Handling

### 1. Section Title Generation
Readable titles are automatically generated from section keys:

```typescript
const getSectionTitle = (sectionKey: string): string => {
  const sectionMapping: { [key: string]: string } = {
    // Current system mappings
    business_impact: "Business Impact & ROI Analysis",
    challenges_position: "Current Challenges & Market Position", 
    change_capacity: "Change Capacity & Digital Maturity",
    decision_makers: "Decision-Making Structure",
    contact_strategy: "Contact Strategy & Approach",
    
    // Future sections automatically handled
    competitive_analysis: "Competitive Landscape Analysis",
    financial_projections: "Financial Impact Projections",
    technology_assessment: "Technology Infrastructure Assessment"
  };
  
  return sectionMapping[sectionKey] || 
    sectionKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
};
```

### 2. Content Formatting for PDF
The system handles various content structures automatically:

```typescript
const addDynamicSection = (doc: jsPDF, title: string, content: any) => {
  // Add section header
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text(title, 20, currentY);
  currentY += 10;
  
  // Format content based on type
  const formattedText = formatContentForPDF(content);
  
  // Add content with proper spacing and page breaks
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  
  const lines = doc.splitTextToSize(formattedText, 170);
  lines.forEach((line: string) => {
    if (currentY > 280) {
      doc.addPage();
      currentY = 20;
    }
    doc.text(line, 20, currentY);
    currentY += 5;
  });
};

const formatContentForPDF = (content: any): string => {
  if (typeof content === 'string') {
    // Remove markdown formatting for PDF
    return content.replace(/[#*`]/g, '');
  }
  
  if (Array.isArray(content)) {
    return content.map((item, index) => 
      `${index + 1}. ${formatContentForPDF(item)}`
    ).join('\n');
  }
  
  if (typeof content === 'object' && content !== null) {
    return Object.entries(content)
      .map(([key, value]) => 
        `${key.replace(/_/g, ' ').toUpperCase()}: ${formatContentForPDF(value)}`
      )
      .join('\n\n');
  }
  
  return String(content);
};
```

## Automatic Integration Benefits

### 1. Future-Proof Exports
- **New Sections Automatic**: Any section added to system prompt appears in exports
- **Zero Maintenance**: No code changes needed for new content types
- **Consistent Formatting**: All sections use uniform styling and structure
- **Complete Coverage**: Nothing generated by AI is missed in exports

### 2. Content Preservation
- **Full Fidelity**: All AI-generated content preserved in JSON exports
- **Readable PDFs**: Complex structures formatted for human consumption  
- **Structured Data**: JSON maintains full data structure for analysis
- **Metadata Included**: Export timestamps, versions, and context preserved

### 3. User Experience
- **Always Complete**: Users get all analysis content regardless of system prompt changes
- **Professional Output**: Consistent, polished PDF formatting
- **Data Analysis Ready**: JSON exports ready for further processing
- **No Missing Content**: Automatic inclusion prevents export gaps

## Export Usage Examples

### 1. PDF Export for Client Presentations
```typescript
// Generate professional PDF for client sharing
const handleExportPDF = async () => {
  try {
    const doc = await exportResearchToPDF(research, research.company_name);
    doc.save(`${research.company_name}_Research_Analysis.pdf`);
    toast.success('PDF exported successfully');
  } catch (error) {
    toast.error('Export failed');
  }
};
```

### 2. JSON Export for Data Analysis
```typescript
// Generate JSON for further analysis or integration
const handleExportJSON = () => {
  try {
    const jsonData = exportToJSON(research);
    const dataStr = JSON.stringify(jsonData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${research.company_name}_Research_Data.json`;
    link.click();
    
    toast.success('JSON exported successfully');
  } catch (error) {
    toast.error('Export failed');
  }
};
```

## Content Structure Examples

### 1. Simple Text Section
```json
{
  "challenges_position": "The company faces significant digital transformation challenges with legacy systems creating operational inefficiencies."
}
```
**PDF Output**: Plain text with section header

### 2. Structured Object Section  
```json
{
  "business_impact": {
    "potential_value": "$500K-2M annually",
    "roi_timeline": "6-12 months", 
    "implementation_risk": "Medium",
    "success_factors": ["executive buy-in", "technical resources"]
  }
}
```
**PDF Output**: Formatted as key-value pairs with proper spacing

### 3. Array-Based Section
```json
{
  "decision_makers": [
    {
      "role": "CTO",
      "influence": "High", 
      "approach": "Technical demonstration"
    },
    {
      "role": "CFO",
      "influence": "Medium",
      "approach": "ROI-focused presentation"
    }
  ]
}
```
**PDF Output**: Numbered list with structured sub-items

## System Prompt Considerations for Exports

### 1. Export-Friendly Content Structure
When designing system prompts, consider export formatting:

- **Use clear section names**: `business_impact` vs `bi_analysis`
- **Structure complex data**: Use objects for related information
- **Avoid excessive nesting**: Keep structure reasonably flat
- **Include context**: Add explanatory text for data points

### 2. PDF-Optimized Content
- **Reasonable length**: Very long sections may need page breaks
- **Clear hierarchy**: Use consistent formatting for subsections
- **Readable formatting**: Avoid excessive markdown in system prompt
- **Structured lists**: Use arrays for items that should be numbered

## Adding New Export Features

### 1. New Section Mappings
To add user-friendly titles for new sections:

```typescript
// Update sectionMapping in exportUtils.ts
const sectionMapping = {
  // Add new mappings
  market_analysis: "Market Analysis & Positioning",
  risk_factors: "Risk Assessment & Mitigation",
  implementation_roadmap: "Implementation Roadmap"
};
```

### 2. Custom Content Formatting
For special formatting requirements:

```typescript
// Add special handling in formatContentForPDF
const formatContentForPDF = (content: any): string => {
  // Special handling for specific section types
  if (content.section_type === 'financial_projections') {
    return formatFinancialData(content);
  }
  
  // Default handling
  return defaultFormat(content);
};
```

## Best Practices

### 1. System Prompt Design
- Design sections with export readability in mind
- Use consistent data structures across sections
- Include section descriptions for context
- Test export output with sample data

### 2. Content Guidelines  
- Keep text concise but comprehensive
- Use structured data for complex information
- Include units and context for numeric data
- Design for both PDF and JSON consumption

### 3. User Experience
- Provide clear export feedback (loading, success, errors)
- Use meaningful file names with company and date
- Ensure exports work across different browsers
- Test exports with various content structures

## Troubleshooting

### 1. Missing Content in Exports
- Verify `research_results` contains the expected data
- Check that section keys match expected patterns
- Ensure content is not null or undefined
- Validate JSON structure is complete

### 2. PDF Formatting Issues
- Check for very long text that needs page breaks
- Verify special characters don't break PDF generation  
- Test with various content structures
- Monitor PDF file size for large analyses

### 3. JSON Export Problems
- Ensure all data is JSON serializable
- Check for circular references in objects
- Validate proper data types throughout structure
- Test JSON parsing of exported files